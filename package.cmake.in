ExternalProject_Add(
  gitache_package_@gitache_package@
  PREFIX @gitache_package_PREFIX@
  INSTALL_DIR @gitache_package_INSTALL_DIR@
  CMAKE_ARGS @gitache_package_CMAKE_ARGS@
  UPDATE_COMMAND $(CMAKE_COMMAND) -E touch /opt/gitache/libcwd_r/src/gitache_package_libcwd_r-stamp/gitache_package_libcwd_r-update
  @external_project_arguments@
)

# File lock support.
ExternalProject_Add_Step(
  gitache_package_@gitache_package@ always_lock
  COMMENT "Cause the lock step to always run"
  ALWAYS 1
)

add_custom_command(
  COMMENT "Locking directory '@gitache_package_PREFIX@' for 'gitache_package_@gitache_package@'"
  OUTPUT "@gitache_package_PREFIX@/src/gitache_package_@gitache_package@-stamp/gitache_package_@gitache_package@-lock_and_always_run"
  BYPRODUCTS "@gitache_package_PREFIX@/gitache-lock" "@gitache_package_PREFIX@/src/gitache_package_@gitache_package@-stamp/gitache_package_@gitache_package@-lock"
  COMMAND @gitache_package_lock_COMMAND@
)
set_property(SOURCE "@gitache_package_PREFIX@/src/gitache_package_@gitache_package@-stamp/gitache_package_@gitache_package@-lock_and_always_run" PROPERTY SYMBOLIC 1)

ExternalProject_Add_Step(
  gitache_package_@gitache_package@ lock_mkdir
  COMMENT "Link step between lock and mkdir"
  DEPENDS "@gitache_package_PREFIX@/src/gitache_package_@gitache_package@-stamp/gitache_package_@gitache_package@-lock_and_always_run"
  DEPENDERS mkdir
)

# Make sure the unlock stamp file exists.
file(TOUCH "@gitache_package_PREFIX@/src/gitache_package_@gitache_package@-stamp/gitache_package_@gitache_package@-lock")

ExternalProject_Add_Step(
  gitache_package_@gitache_package@ unlock
  COMMAND @gitache_package_unlock_COMMAND@
  COMMENT "Unlocking directory '@gitache_package_PREFIX@' for 'gitache_package_@gitache_package@'"
  DEPENDEES install
  DEPENDS "@gitache_package_PREFIX@/src/gitache_package_@gitache_package@-stamp/gitache_package_@gitache_package@-lock_and_always_run"
  WORKING_DIRECTORY "@gitache_package_PREFIX@"
)

# Make sure the unlock stamp file exists.
file(TOUCH "@gitache_package_PREFIX@/src/gitache_package_@gitache_package@-stamp/gitache_package_@gitache_package@-unlock")

gitache_create_step(custom "@gitache_package@" SILENT)

if (NOT "@GIT_TAG@" STREQUAL "")
  # Update support for git.
  add_custom_command(
    COMMENT "Performing gitupdate step for 'gitache_package_@gitache_package@'"
    OUTPUT "@gitache_package_PREFIX@/gitache-gitupdate" # Not really created at all, so it always runs.
    BYPRODUCTS "@gitache_package_PREFIX@/src/gitache_package_@gitache_package@-stamp/gitache_package_@gitache_package@-gitupdate"
    MAIN_DEPENDENCY "@gitache_package_PREFIX@/src/gitache_package_@gitache_package@-stamp/gitache_package_@gitache_package@-lock_and_always_run"
    DEPENDS "@gitache_package_PREFIX@/src/gitache_package_@gitache_package@-stamp/gitache_package_@gitache_package@-download"
    WORKING_DIRECTORY "@gitache_package_PREFIX@/src/gitache_package_@gitache_package@"
    COMMAND @gitache_package_update_COMMAND@
  )
  # This is only needed for some generators.
  set_property(SOURCE "@gitache_package_PREFIX@/gitache-gitupdate" PROPERTY SYMBOLIC 1)

  ExternalProject_Add_Step(
    gitache_package_@gitache_package@ update_configure
    COMMENT "Link step between update and configure"
    DEPENDS "@gitache_package_PREFIX@/src/gitache_package_@gitache_package@-stamp/gitache_package_@gitache_package@-gitupdate"
    DEPENDERS configure
  )

  ExternalProject_Add_Step(
    gitache_package_@gitache_package@ always_update
    COMMENT ""
    DEPENDS "@gitache_package_PREFIX@/gitache-gitupdate"
    DEPENDS "@gitache_package_PREFIX@/src/gitache_package_@gitache_package@-stamp/step_libcwd_r-custom"
    ALWAYS 1
  )

  # Make sure the gitupdate stamp file exists.
  file(TOUCH "@gitache_package_PREFIX@/src/gitache_package_@gitache_package@-stamp/gitache_package_@gitache_package@-gitupdate")
endif ()
